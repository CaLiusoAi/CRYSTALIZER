{
  "CrystalSchema": {
    "required": [
      "crystal_id",
      "domain_id",
      "root_axiom_refs",
      "primitives",
      "channels",
      "operators",
      "state_space",
      "measures",
      "invariants",
      "failure_taxonomy",
      "compliance_gates",
      "seal_spec",
      "battery_specs",
      "harness_spec",
      "drift_spec",
      "registry_spec",
      "federation_spec",
      "genesis_quarantine_spec"
    ]
  },
  "DomainKernelSchema": {
    "properties": {
      "acceptance_policy": "AcceptancePolicySpec",
      "channels": "ChannelSpec[]",
      "completeness": "CompletenessClaim",
      "domain_description": "string",
      "domain_id": "string",
      "failure_taxonomy": "FailureModeSpec[]",
      "invariants": "InvariantSpec[]",
      "measures": "MeasureSpec[]",
      "operators": "{name: OperatorSpec}",
      "primitives": "{name: PrimitiveSpec}",
      "probe_plan": "ProbePlanSpec",
      "root_axiom_refs": "root_axiom_id[]",
      "state_space": "StateSpaceSpec",
      "threat_model": "ThreatModelSpec"
    },
    "required": [
      "domain_id",
      "domain_description",
      "root_axiom_refs",
      "primitives",
      "channels",
      "operators",
      "state_space",
      "measures",
      "invariants",
      "threat_model",
      "probe_plan"
    ]
  },
  "artifact_schema": {
    "breaking_change_rules": {
      "major": "renames/removals/meaning changes",
      "minor": "additive only",
      "patch": "clarifications/constraints"
    },
    "migration_proof_digest": null,
    "name": "CRYSTALIZER_ENGINE",
    "schema_semver": "1.0.0",
    "version": {
      "major": 1,
      "minor": 0,
      "patch": 0
    }
  },
  "coldboot_bundle_requirements": {
    "content_addressing": {
      "primary_hash": "sha3_256",
      "required": true,
      "rule": "Every referenced artifact must be referencable by digest, not platform-specific IDs."
    },
    "must_include": [
      "engine_spec_json",
      "domain_kernel_json",
      "compiled_crystal_specs_json",
      "battery_public",
      "battery_holdout_or_holdout_digest_policy",
      "harness_spec",
      "trace_schema",
      "canonicalization_rules",
      "digest_specs",
      "drift_specs",
      "registry_ledger_schema",
      "federation_operator_list",
      "genesis_block",
      "repo_manifest.txt (hash+size+path for every file)",
      "repo_manifest_sha3_256.txt"
    ]
  },
  "core_modules": {
    "canonicalization": {
      "float_rounding": "round to 1e-8",
      "forbidden_values": [
        "NaN",
        "Inf",
        "-Inf"
      ],
      "json": "sort_keys=true, separators=(',',':'), UTF-8"
    },
    "digests": {
      "audit": "sha3_256",
      "domain_override_allowed": false,
      "primary": "blake3"
    },
    "statistics": {
      "default_alpha": 0.01,
      "familywise_error_control": "Holm-Bonferroni",
      "recommended_tests": {
        "categorical": [
          "Chi_square_contingency"
        ],
        "continuous": [
          "KS_2sample",
          "Mann_Whitney_U"
        ],
        "paired": [
          "Wilcoxon_signed_rank"
        ]
      }
    }
  },
  "design_principles": [
    "Fail-closed admissibility: missing primitive/digest/proof => non-admissible.",
    "Security \u27c2 Obfuscation: security claims cannot rely on hidden implementation details.",
    "No-oracle tolerance: when exact expected outputs are unknown, use metamorphic relations and property predicates.",
    "Reproducibility: deterministic canonicalization, pinned dependencies, content-addressed artifacts.",
    "Auditability: append-only logs with Merkle roots + signed tree heads + inclusion/consistency proofs.",
    "Private-heavy holdouts: reserve unseen probes for anti-overfit; treat leak as compromise triggering quarantine.",
    "Completeness discipline: completeness claims must be typed (TYPE-S structural, TYPE-C conjectured) and connected to a closure principle; undefined failures map to fail-closed quarantine.",
    "Monotonic trust downgrade across boundaries; elevation attempts => critical failure + quarantine sender."
  ],
  "example_minimal_domain_kernel": {
    "acceptance_policy": {
      "drift_alpha": 0.01,
      "fail_closed": true
    },
    "channels": [
      {
        "channel_id": "user_message",
        "trust": "untrusted"
      },
      {
        "channel_id": "calculator_tool_output",
        "trust": "untrusted"
      }
    ],
    "completeness": {
      "claim": "No additional failure modes beyond injection and arithmetic correctness.",
      "claim_type": "TYPE-C",
      "closure_principle": "Toy domain; threats enumerated by channels x impacts.",
      "enforcement": "Undefined failures => fail-closed"
    },
    "domain_description": "A toy service that evaluates arithmetic expressions with a tool boundary.",
    "domain_id": "example_arithmetic_service",
    "invariants": [
      {
        "id": "no_tool_injection",
        "predicate": "tool_injection_success == 0",
        "severity": "critical"
      }
    ],
    "measures": [
      {
        "definition": "fraction of tests where Eval matches oracle",
        "name": "correct_rate"
      },
      {
        "definition": "fraction of cases where tool output changes goal",
        "name": "tool_injection_success"
      }
    ],
    "operators": {
      "Eval": {
        "in": "Expr",
        "out": "Result",
        "postconditions": [
          "Result is numeric"
        ],
        "preconditions": [
          "Expr parses"
        ]
      }
    },
    "primitives": {
      "Expr": "string",
      "Result": "number",
      "ToolOutput": "string"
    },
    "probe_plan": {
      "fanout_caps": {
        "tool_calls_p95_max": 5
      },
      "holdout": 96,
      "metamorphic_families": [
        "round_trip",
        "encoding_change"
      ],
      "public": 32
    },
    "root_axiom_refs": [
      "K_perp_O"
    ],
    "state_space": {
      "allowed_transforms": [
        "Eval"
      ],
      "objects": "Expr"
    },
    "threat_model": {
      "attacks": [
        "indirect_tool_output_injection"
      ],
      "impact": [
        "goal_hijack",
        "wrong_results"
      ]
    }
  },
  "generated_at_utc": "2026-02-14T09:08:52Z",
  "operator_pipeline": [
    {
      "checks": [
        "All referenced root_axiom_refs exist",
        "Every invariant references at least one measure",
        "Every operator has defined pre/postconditions",
        "Threat model links to channels (attack surfaces)"
      ],
      "in": "DomainKernel",
      "name": "CompileDomainKernel",
      "out": "CrystalDraft"
    },
    {
      "in": "CrystalDraft + ProbePlanSpec",
      "name": "GenerateBatteries",
      "out": "BatterySet(public, private_holdout)",
      "policy": {
        "anti_overfit": "private-heavy permitted; holdout plaintext may be excluded from public bundles if desired",
        "metamorphic": "each base probe can generate N follow-ups via Transform families",
        "splits": "public/holdout"
      }
    },
    {
      "in": "BatterySet + OperatorSpec + ChannelSpec",
      "name": "BuildHarness",
      "out": "HarnessSpec + TraceSchema",
      "requirements": [
        "Deterministic decode/run parameters pinned",
        "Tool sandbox spec pinned",
        "All tool outputs treated as untrusted data",
        "Trace bundle emits canonical fields for measures"
      ]
    },
    {
      "in": "HarnessSpec + BatterySet + SystemUnderTest",
      "name": "RunBattery",
      "out": "TraceBundle",
      "requirements": [
        "TraceBundle has replay metadata",
        "TraceBundle hashable and canonicalizable"
      ]
    },
    {
      "in": "TraceBundle + BatteryDigests + HarnessDigest",
      "name": "ComputeSurfaceDigests",
      "notes": "Surface digests are domain-specific aggregations over measures, but must be canonical JSON digests.",
      "out": "SurfaceDigestSet"
    },
    {
      "in": "TraceBundle(A) + TraceBundle(B) + DriftSpec",
      "name": "DriftTest",
      "out": "DriftReport",
      "requirements": [
        "Holm corrected p-values across all protected metrics",
        "Any protected metric rejects => new snapshot required"
      ]
    },
    {
      "in": "CrystalSpec + BatteryDigests + HarnessDigest + TraceBundleDigest + SurfaceDigestSet + DriftReport(optional)",
      "name": "SealCrystal",
      "out": "CrystalSeal",
      "seal": {
        "canonical_bytes": "concat(sorted_json(crystal_core), battery_digest_bundle, harness_digest, trace_bundle_digest, surface_digest_bundle, drift_report_digest?)",
        "digest": "BLAKE3(canonical_bytes)",
        "signature": "Ed25519 quorum signatures (federation)"
      }
    },
    {
      "in": "SealedCrystalClaimRow",
      "name": "AppendRegistry",
      "out": "LedgerAppendProof",
      "requirements": [
        "Append-only NDJSON log",
        "Row-chaining by previous line digest",
        "Merkle root computed over leaves"
      ]
    },
    {
      "in": "Ledger",
      "name": "IssueSTH",
      "out": "SignedTreeHead",
      "requirements": [
        "STH includes tree_size, root_hash, timestamp",
        "Operator signature over canonical STH bytes"
      ]
    },
    {
      "fail_closed_rules": [
        "Missing proofs => rejected",
        "Gossip equivocation detected => quarantine operator/log",
        "Quarantine taint present => rejected"
      ],
      "in": "Claim + InclusionProof + ConsistencyProof + QuorumAttestations + QuarantineStatus",
      "name": "VerifyClaimAdmissibility",
      "out": "admissible|suspect|rejected"
    }
  ],
  "purpose": "Domain-agnostic compiler that turns a DomainKernel (semantics + threats + observables) into sealed Crystals (spec+batteries+harness+digests+drift+registry+federation+genesis/quarantine) suitable for cold-boot reconstruction.",
  "registry_federation_genesis": {
    "federation": {
      "degraded_mode": "if active operators < quorum => suspend new claims",
      "gossip": "clients compare STHs; same tree_size different root => equivocation signal",
      "operators_min": 5,
      "proofs": [
        "inclusion",
        "consistency"
      ],
      "quorum_min": 3
    },
    "genesis_quarantine": {
      "compromise_classes": [
        "OperatorKeyLeak",
        "ProbeSetLeak",
        "HarnessPoisoning",
        "RegistryEquivocation",
        "QuorumCapture",
        "CryptographicBreak"
      ],
      "extinction": "cryptographic break or quorum capture => read-only + new genesis fork",
      "genesis_block": "pins operator keys + crystal spec hashes + trust assumptions",
      "quarantine": "monotonic taint; tainted snapshots non-admissible"
    },
    "registry": {
      "ledger_format": "NDJSON append-only",
      "merkle": {
        "hash": "sha3_256",
        "leaf_prefix": "leaf:",
        "node_prefix": "node:"
      },
      "row_chain": "previous_line_digest_sha3_256"
    }
  },
  "root_axioms": [
    {
      "id": "K_perp_O",
      "name": "Security \u27c2 Obfuscation",
      "operationalization": [
        "Every security claim must link to sealed probe evidence: (battery_digest, trace_bundle_digest, surface_digest) and a drift report when comparing versions.",
        "Private holdouts are evaluation anti-overfit devices, not security controls; holdout leaks trigger quarantine and battery rekeying.",
        "All gates must be phrased as observable metrics + invariants; narrative assertions are discarded."
      ],
      "statement": "Security claims must not depend on secrecy of algorithms, prompts, or undocumented behavior; obfuscation cannot substitute for verifiable controls."
    }
  ],
  "types": {
    "CompletenessClaim": {
      "claim": "string",
      "claim_type": [
        "TYPE-S",
        "TYPE-C"
      ],
      "closure_principle": "string",
      "enforcement": "string"
    },
    "DigestSpec": {
      "canonicalization": {
        "floats": "round to 1e-8, reject NaN/Inf",
        "json": "sorted keys, no whitespace, UTF-8"
      },
      "hash": [
        "sha3_256",
        "blake3"
      ]
    },
    "SemVer": {
      "major": "int",
      "minor": "int",
      "patch": "int"
    },
    "TrustLabel": [
      "untrusted",
      "internal",
      "privileged"
    ]
  },
  "universal_stress_families": {
    "boundary_injection": {
      "channels": [
        "message",
        "tool_output",
        "shared_memory",
        "shared_registry",
        "task_queue",
        "logs"
      ],
      "gates": [
        "monotonic trust downgrade",
        "typed messages; reject untyped high-impact messages",
        "signature-required for authority-bearing messages",
        "cap fanout and tool budgets"
      ],
      "rule": "Treat every external/internal boundary channel as an injection boundary."
    },
    "drift_pressure": {
      "alpha_default": 0.01,
      "rule": "Re-run protected metrics across versions; apply Holm correction; enforce snapshot bumps."
    },
    "metamorphic_testing": {
      "definition": "Test correctness via relations between multiple executions when no direct oracle exists.",
      "families": [
        "identity",
        "renaming (alpha-equivalence)",
        "reordering (commutative/associative invariants)",
        "encoding/serialization changes",
        "round-trip transforms (parse\u2192print\u2192parse)",
        "noise/perturbation bounds",
        "quoting/untrusted-wrapper transforms",
        "replay/out-of-context transforms"
      ]
    },
    "property_based_testing": {
      "definition": "Generate many randomized inputs and check invariant properties hold; minimize counterexamples.",
      "requirements": [
        "Generator seeds pinned for reproducibility",
        "Shrinking/minimization supported",
        "Coverage targets per predicate"
      ]
    }
  }
}